name: Zombie Registry

on:
  issues:
    types: [opened]

permissions:
  contents: write
  issues: write

concurrency:
  group: zombie-registry
  cancel-in-progress: false

jobs:
  register:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");

            const issue = context.payload.issue;
            const title = (issue.title || "").trim();

            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –Ω–∞—à–∏ –∑–∞—è–≤–∫–∏
            if (!title.startsWith("ZOMBIE_INFECTION")) {
              return;
            }

            const body = issue.body || "";
            const get = (k) => {
              const re = new RegExp(`^${k}\\s*:\\s*(.*)$`, "mi");
              const m = body.match(re);
              return m ? (m[1] || "").trim() : "";
            };

            // –û—á–µ–Ω—å –ø—Ä–æ—Å—Ç–∞—è —Å–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è
            const safeNick = (s) => String(s || "")
              .trim()
              .slice(0, 20)
              .replace(/[^\p{L}\p{N}_\-. ]/gu, "");

            const claim = get("claim");
            if (!claim || claim.length < 6) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: "‚ùå –ó–∞—è–≤–∫–∞ –±–µ–∑ claim-—Ç–æ–∫–µ–Ω–∞. –û—Ç–∫—Ä–æ–π —Å–∞–π—Ç –∏ –Ω–∞–∂–º–∏ ¬´–ü–æ–ª—É—á–∏—Ç—å –Ω–æ–º–µ—Ä –∑–∞—Ä–∞–∂–µ–Ω–∏—è¬ª –µ—â—ë —Ä–∞–∑."
              });
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: "closed"
              });
              return;
            }

            const nick = safeNick(get("nick")) || "anonymous";
            const from_id_raw = get("from_id");
            const from_id = from_id_raw ? parseInt(from_id_raw, 10) : null;
            const from_nick = safeNick(get("from")) || "";
            const strain = (get("strain") || "").toUpperCase().replace(/[^A-Z0-9]/g, "").slice(0, 8) || "UNKWN";

            const path = "registry.json";
            let reg = { updated_at: new Date().toISOString(), total: 0, infections: [] };
            if (fs.existsSync(path)) {
              try { reg = JSON.parse(fs.readFileSync(path, "utf8")); } catch(e) {}
            }
            if (!reg || typeof reg !== "object") reg = { updated_at: new Date().toISOString(), total: 0, infections: [] };
            if (!Array.isArray(reg.infections)) reg.infections = [];
            if (typeof reg.total !== "number") reg.total = reg.infections.length;

            // –î–µ–¥—É–ø: –µ—Å–ª–∏ claim —É–∂–µ –µ—Å—Ç—å ‚Äî –Ω–µ —Å–æ–∑–¥–∞—ë–º –≤—Ç–æ—Ä–æ–π —Ä–∞–∑
            const exists = reg.infections.find(x => x && x.claim === claim);
            if (exists) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `‚ö†Ô∏è –≠—Ç–æ—Ç claim —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –∫–∞–∫ #${exists.id}.`
              });
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: "closed"
              });
              return;
            }

            const id = (reg.total || 0) + 1;

            const entry = {
              id,
              nick,
              claim,
              strain,
              from_id: Number.isFinite(from_id) ? from_id : null,
              from_nick: from_nick || null,
              created_at: issue.created_at
            };

            reg.infections.push(entry);
            reg.total = id;
            reg.updated_at = new Date().toISOString();

            fs.writeFileSync(path, JSON.stringify(reg, null, 2), "utf8");

            // –ö–æ–º–º–∏—Ç–∏–º
            const exec = require("child_process").execSync;
            exec('git config user.name "zombie-registry-bot"');
            exec('git config user.email "actions@users.noreply.github.com"');
            exec("git add registry.json");
            exec(`git commit -m "registry: add infection #${id}" || true`);
            exec("git push");

            // –ö–æ–º–º–µ–Ω—Ç + –∑–∞–∫—Ä—ã—Ç—å issue
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: `üßü‚Äç‚ôÇÔ∏è **–ó–ê–†–ï–ì–ò–°–¢–†–ò–†–û–í–ê–ù–û**\n\n–¢–≤–æ–π –Ω–æ–º–µ—Ä –∑–∞—Ä–∞–∂–µ–Ω–∏—è: **#${id}**\n–®—Ç–∞–º–º: **${strain}**\n–ù–∏–∫: **${nick}**\n\n–û—Ç–∫—Ä–æ–π —Å–∞–π—Ç –∏ —É–≤–∏–¥–∏—à—å —Å–µ–±—è –≤ —Ä–µ–µ—Å—Ç—Ä–µ (–ø–æ claim/–Ω–∏–∫—É).`
            });

            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              state: "closed"
            });
